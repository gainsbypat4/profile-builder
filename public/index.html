<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Builder Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .highlight-box { background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 50%, #2563eb 100%); }
    @media print { .no-print { display: none !important; } }
    .tab-active { border-bottom: 3px solid #2563eb; color: #1e40af; font-weight: 600; }
    .score-ring { transition: stroke-dashoffset 0.8s ease-in-out; }
    .overlap-warning { animation: pulse-warn 2s infinite; }
    @keyframes pulse-warn { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 2px #2563eb40; border-color: #2563eb; }
  </style>
  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, useCallback } = React;

    // ==================== HOSPITAL DATABASE ====================
    const HOSPITAL_DATABASE = {
      "tampa general hospital": { officialName: "Tampa General Hospital", city: "Tampa", state: "FL", beds: 1041, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "cleveland clinic": { officialName: "Cleveland Clinic Main Campus", city: "Cleveland", state: "OH", beds: 1400, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "jackson memorial hospital": { officialName: "Jackson Memorial Hospital", city: "Miami", state: "FL", beds: 1547, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "johns hopkins hospital": { officialName: "Johns Hopkins Hospital", city: "Baltimore", state: "MD", beds: 1162, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "mayo clinic": { officialName: "Mayo Clinic - Rochester", city: "Rochester", state: "MN", beds: 2059, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "cedars-sinai": { officialName: "Cedars-Sinai Medical Center", city: "Los Angeles", state: "CA", beds: 886, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "mass general": { officialName: "Massachusetts General Hospital", city: "Boston", state: "MA", beds: 999, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "massachusetts general hospital": { officialName: "Massachusetts General Hospital", city: "Boston", state: "MA", beds: 999, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "ucla medical center": { officialName: "UCLA Medical Center", city: "Los Angeles", state: "CA", beds: 520, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "stanford hospital": { officialName: "Stanford Health Care", city: "Stanford", state: "CA", beds: 613, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "northwestern memorial hospital": { officialName: "Northwestern Memorial Hospital", city: "Chicago", state: "IL", beds: 894, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "baptist hospital of miami": { officialName: "Baptist Hospital of Miami", city: "Miami", state: "FL", beds: 728, traumaLevel: "Level II", teaching: false, emr: "Cerner" },
      "adventhealth orlando": { officialName: "AdventHealth Orlando", city: "Orlando", state: "FL", beds: 1368, traumaLevel: "Level I", teaching: true, emr: "Cerner" },
      "houston methodist": { officialName: "Houston Methodist Hospital", city: "Houston", state: "TX", beds: 907, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "emory university hospital": { officialName: "Emory University Hospital", city: "Atlanta", state: "GA", beds: 733, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "mount sinai hospital": { officialName: "Mount Sinai Hospital", city: "New York", state: "NY", beds: 1139, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "nyu langone": { officialName: "NYU Langone Medical Center", city: "New York", state: "NY", beds: 834, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "university of michigan hospital": { officialName: "University of Michigan Hospital", city: "Ann Arbor", state: "MI", beds: 1000, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "duke university hospital": { officialName: "Duke University Hospital", city: "Durham", state: "NC", beds: 957, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "ucsf medical center": { officialName: "UCSF Medical Center", city: "San Francisco", state: "CA", beds: 600, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "vanderbilt university medical center": { officialName: "Vanderbilt University Medical Center", city: "Nashville", state: "TN", beds: 1000, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "ohio state wexner medical center": { officialName: "Ohio State Wexner Medical Center", city: "Columbus", state: "OH", beds: 1300, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "university of pittsburgh medical center": { officialName: "UPMC Presbyterian", city: "Pittsburgh", state: "PA", beds: 757, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "upmc": { officialName: "UPMC Presbyterian", city: "Pittsburgh", state: "PA", beds: 757, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "nebraska medicine": { officialName: "Nebraska Medicine", city: "Omaha", state: "NE", beds: 809, traumaLevel: "Level I", teaching: true, emr: "Epic" },
      "methodist hospital omaha": { officialName: "Methodist Hospital", city: "Omaha", state: "NE", beds: 460, traumaLevel: "Level II", teaching: false, emr: "Cerner" },
      "chi health": { officialName: "CHI Health", city: "Omaha", state: "NE", beds: 695, traumaLevel: "Level II", teaching: false, emr: "Epic" },
      "boys town national research hospital": { officialName: "Boys Town National Research Hospital", city: "Omaha", state: "NE", beds: 54, traumaLevel: null, teaching: true, emr: "Epic" },
    };

    // ==================== UNIT TYPE TEMPLATES ====================
    const UNIT_TEMPLATES = {
      "icu": { typicalRatio: "1-2:1", populations: ["Critical care", "Ventilator patients", "Post-cardiac surgery", "Sepsis"], responsibilities: ["Continuous hemodynamic monitoring", "Ventilator management and weaning protocols", "Vasopressor and sedation titration", "Central line and arterial line management", "Rapid response and code team participation"] },
      "med-surg": { typicalRatio: "5-6:1", populations: ["Post-surgical", "General medical", "Ortho", "Neuro"], responsibilities: ["Medication administration and IV therapy", "Post-operative care and wound management", "Patient assessment and care planning", "Discharge planning and patient education", "Telemetry monitoring"] },
      "emergency": { typicalRatio: "4-5:1", populations: ["Trauma", "Chest pain", "Stroke", "Pediatric emergencies"], responsibilities: ["Triage and rapid assessment", "Trauma stabilization and resuscitation", "Emergency medication administration", "Procedural assistance and sedation", "Multi-system patient management"] },
      "labor and delivery": { typicalRatio: "2-3:1", populations: ["High-risk OB", "Postpartum", "Neonatal"], responsibilities: ["Fetal monitoring and interpretation", "Labor support and pain management", "C-section circulating and recovery", "Postpartum hemorrhage management", "Neonatal resuscitation"] },
      "operating room": { typicalRatio: "1:1", populations: ["Surgical patients all specialties"], responsibilities: ["Surgical scrub and circulating", "Sterile field management", "Surgical instrument and equipment knowledge", "Patient positioning and safety", "Specimen handling and documentation"] },
      "telemetry": { typicalRatio: "4-5:1", populations: ["Cardiac", "Post-procedure", "Step-down"], responsibilities: ["Continuous cardiac monitoring", "Rhythm interpretation and intervention", "Post-cardiac catheterization care", "Medication titration", "Patient education on cardiac health"] },
      "oncology": { typicalRatio: "4-5:1", populations: ["Chemo patients", "Radiation", "Palliative"], responsibilities: ["Chemotherapy administration", "Central line management and blood draws", "Symptom management and pain control", "Oncologic emergency recognition", "Patient and family education"] },
      "pediatrics": { typicalRatio: "3-4:1", populations: ["General pediatric", "Respiratory", "Post-surgical"], responsibilities: ["Pediatric assessment and vital signs", "Weight-based medication calculations", "Family-centered care coordination", "Developmental milestone monitoring", "Pediatric emergency response"] },
      "nicu": { typicalRatio: "1-2:1", populations: ["Premature infants", "Congenital anomalies", "Respiratory distress"], responsibilities: ["Neonatal ventilator management", "Thermoregulation and isolette care", "Feeding support and gavage", "Developmental care practices", "Parent education and bonding support"] },
      "picu": { typicalRatio: "1-2:1", populations: ["Critically ill pediatric", "Post-surgical pediatric", "Respiratory failure"], responsibilities: ["Pediatric hemodynamic monitoring", "Pediatric ventilator management", "Weight-based drip calculations", "Family-centered critical care", "Pediatric code team participation"] },
      "cvor": { typicalRatio: "1:1", populations: ["Open heart surgery", "Valve replacement", "CABG"], responsibilities: ["Cardiac surgical scrub and circulating", "Cardiopulmonary bypass support", "Intra-aortic balloon pump management", "Sternotomy instrument proficiency", "Post-op cardiac recovery"] },
    };

    // ==================== SCORECARD RUBRICS ====================
    const SCORECARD_RUBRICS = {
      "icu": { minYears: 2, idealYears: 4, requiredCerts: ["BLS", "ACLS"], preferredCerts: ["CCRN", "PALS"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 400 }, weight: { years: 25, certs: 20, license: 20, facility: 20, chargeExp: 15 } },
      "med-surg": { minYears: 1, idealYears: 2, requiredCerts: ["BLS"], preferredCerts: ["ACLS", "MEDSURG-BC"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 300 }, weight: { years: 20, certs: 15, license: 25, facility: 20, chargeExp: 20 } },
      "emergency": { minYears: 2, idealYears: 3, requiredCerts: ["BLS", "ACLS"], preferredCerts: ["TNCC", "PALS", "CEN"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 400 }, weight: { years: 25, certs: 25, license: 20, facility: 20, chargeExp: 10 } },
      "labor and delivery": { minYears: 2, idealYears: 3, requiredCerts: ["BLS"], preferredCerts: ["ACLS", "NRP", "RNC-OB", "AWHONN"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 300 }, weight: { years: 25, certs: 20, license: 20, facility: 20, chargeExp: 15 } },
      "operating room": { minYears: 2, idealYears: 3, requiredCerts: ["BLS"], preferredCerts: ["ACLS", "CNOR"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 300 }, weight: { years: 30, certs: 15, license: 20, facility: 20, chargeExp: 15 } },
      "telemetry": { minYears: 1, idealYears: 2, requiredCerts: ["BLS", "ACLS"], preferredCerts: ["PCCN"], idealLicense: "compact", idealFacility: { traumaLevel: "Level II", teaching: false, minBeds: 200 }, weight: { years: 20, certs: 20, license: 25, facility: 15, chargeExp: 20 } },
      "pediatrics": { minYears: 2, idealYears: 3, requiredCerts: ["BLS", "PALS"], preferredCerts: ["CPN"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 200 }, weight: { years: 25, certs: 25, license: 20, facility: 15, chargeExp: 15 } },
      "default": { minYears: 1, idealYears: 3, requiredCerts: ["BLS"], preferredCerts: ["ACLS"], idealLicense: "compact", idealFacility: { traumaLevel: "Level I", teaching: true, minBeds: 300 }, weight: { years: 25, certs: 20, license: 20, facility: 20, chargeExp: 15 } },
    };

    // ==================== SCORING FUNCTION ====================
    function calculateScore(data, additionalData) {
      const specialty = (data.primarySpecialty || '').toLowerCase().replace(/[^a-z ]/g, '').trim();
      const rubric = SCORECARD_RUBRICS[specialty] || SCORECARD_RUBRICS["default"];
      const w = rubric.weight;
      let scores = {};

      // Years score
      const yrs = parseInt(data.yearsExperience) || 0;
      if (yrs >= rubric.idealYears) scores.years = 100;
      else if (yrs >= rubric.minYears) scores.years = 50 + ((yrs - rubric.minYears) / (rubric.idealYears - rubric.minYears)) * 50;
      else if (yrs > 0) scores.years = (yrs / rubric.minYears) * 50;
      else scores.years = 0;

      // Cert score
      const certs = (data.certifications || []).map(c => typeof c === 'string' ? c.toUpperCase() : (c.name || '').toUpperCase());
      const allLicCerts = [...certs];
      if (additionalData?.certifications) {
        additionalData.certifications.forEach(c => { if (c.name) allLicCerts.push(c.name.toUpperCase()); });
      }
      const hasRequired = rubric.requiredCerts.every(rc => allLicCerts.some(c => c.includes(rc)));
      const prefCount = rubric.preferredCerts.filter(pc => allLicCerts.some(c => c.includes(pc))).length;
      scores.certs = hasRequired ? 60 + (prefCount / Math.max(rubric.preferredCerts.length, 1)) * 40 : (prefCount > 0 ? 30 : 0);

      // License score
      const licenses = [...(data.licenses || []), ...(additionalData?.licenses || [])];
      const hasCompact = licenses.some(l => l.compact);
      const licCount = licenses.length;
      if (hasCompact && licCount >= 2) scores.license = 100;
      else if (hasCompact) scores.license = 85;
      else if (licCount >= 2) scores.license = 70;
      else if (licCount === 1) scores.license = 50;
      else scores.license = 0;

      // Facility experience score
      const jobs = data.workHistory || [];
      let bestFacility = 0;
      jobs.forEach(job => {
        let fs = 0;
        const hd = job.hospitalData;
        if (hd) {
          if (hd.traumaLevel === "Level I") fs += 40;
          else if (hd.traumaLevel === "Level II") fs += 25;
          if (hd.teaching) fs += 30;
          if (hd.beds >= rubric.idealFacility.minBeds) fs += 30;
          else if (hd.beds >= 200) fs += 15;
        } else {
          fs = 30; // Unknown facility gets base score
        }
        bestFacility = Math.max(bestFacility, fs);
      });
      scores.facility = bestFacility;

      // Charge experience
      const hasCharge = jobs.some(j => j.chargeExperience);
      scores.chargeExp = hasCharge ? 100 : 0;

      // Weighted total
      const total = Math.round(
        (scores.years * w.years + scores.certs * w.certs + scores.license * w.license + scores.facility * w.facility + scores.chargeExp * w.chargeExp) / 100
      );

      return { total: Math.min(total, 100), scores, rubric, specialty: specialty || 'default' };
    }

    // ==================== OVERLAP DETECTION ====================
    function detectOverlaps(workHistory) {
      if (!workHistory || workHistory.length < 2) return [];
      const overlaps = [];
      const parseDate = (d) => {
        if (!d) return null;
        if (d.toLowerCase().includes('present')) return new Date();
        const parsed = new Date(d);
        return isNaN(parsed) ? null : parsed;
      };
      for (let i = 0; i < workHistory.length; i++) {
        for (let j = i + 1; j < workHistory.length; j++) {
          const a = { start: parseDate(workHistory[i].startDate), end: parseDate(workHistory[i].endDate) };
          const b = { start: parseDate(workHistory[j].startDate), end: parseDate(workHistory[j].endDate) };
          if (a.start && a.end && b.start && b.end) {
            if (a.start <= b.end && b.start <= a.end) {
              overlaps.push({
                job1: workHistory[i],
                job2: workHistory[j],
                job1Index: i,
                job2Index: j
              });
            }
          }
        }
      }
      return overlaps;
    }

    // ==================== HOSPITAL MATCHING ====================
    function matchHospital(facilityName) {
      if (!facilityName) return null;
      const normalized = facilityName.toLowerCase().trim();
      if (HOSPITAL_DATABASE[normalized]) return HOSPITAL_DATABASE[normalized];
      for (const [key, data] of Object.entries(HOSPITAL_DATABASE)) {
        if (normalized.includes(key) || key.includes(normalized)) return data;
      }
      const words = normalized.split(/\s+/);
      for (const [key, data] of Object.entries(HOSPITAL_DATABASE)) {
        const keyWords = key.split(/\s+/);
        const matchCount = words.filter(w => keyWords.includes(w)).length;
        if (matchCount >= 2) return data;
      }
      return null;
    }

    // ==================== DETECT UNIT TYPE ====================
    function detectUnitType(title, unit) {
      const text = ((title || '') + ' ' + (unit || '')).toLowerCase();
      if (text.includes('icu') || text.includes('intensive care') || text.includes('critical care')) return 'icu';
      if (text.includes('emergency') || text.includes(' er ') || text.includes('trauma')) return 'emergency';
      if (text.includes('med-surg') || text.includes('med surg') || text.includes('medical surgical') || text.includes('medsurg')) return 'med-surg';
      if (text.includes('labor') || text.includes('delivery') || text.includes('l&d') || text.includes('ob ') || text.includes('obstetric')) return 'labor and delivery';
      if (text.includes('operating room') || text.includes(' or ') || text.includes('surgical services') || text.includes('perioperative')) return 'operating room';
      if (text.includes('telemetry') || text.includes('tele') || text.includes('cardiac') || text.includes('step-down')) return 'telemetry';
      if (text.includes('oncology') || text.includes('cancer')) return 'oncology';
      if (text.includes('nicu') || text.includes('neonatal intensive')) return 'nicu';
      if (text.includes('picu') || text.includes('pediatric intensive') || text.includes('pediatric icu')) return 'picu';
      if (text.includes('pediatric') || text.includes('peds')) return 'pediatrics';
      if (text.includes('cvor') || text.includes('cardiovascular or')) return 'cvor';
      return null;
    }

    // ==================== DEDUP HELPERS ====================
    function dedupLicenses(extractedLicenses, additionalLicenses) {
      const all = [...(extractedLicenses || []), ...(additionalLicenses || [])];
      const seen = new Set();
      return all.filter(lic => {
        const key = `${(lic.state || '').toUpperCase()}-${(lic.type || 'RN').toUpperCase()}-${lic.compact ? 'C' : 'N'}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    function dedupCerts(extractedCerts, additionalCerts) {
      const normalize = (c) => (typeof c === 'string' ? c : (c.name || '')).toUpperCase().trim();
      const all = [
        ...(extractedCerts || []).map(c => typeof c === 'string' ? { name: c } : c),
        ...(additionalCerts || [])
      ];
      const seen = new Set();
      return all.filter(cert => {
        const key = normalize(cert);
        if (!key || seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    // ==================== OVERLAP NOTE GENERATION ====================
    const OVERLAP_LABELS = {
      'prn': 'Concurrent PRN/Per Diem position',
      'staff_and_travel': 'Staff position held alongside travel assignment',
      'transition': 'Transition period between positions',
      'error': 'Date discrepancy ‚Äî needs correction on resume',
    };

    function getOverlapNoteForJob(jobIndex, overlaps, overlapResolutions, overlapPrnShifts) {
      const notes = [];
      overlaps.forEach((o, oi) => {
        if (o.job1Index === jobIndex || o.job2Index === jobIndex) {
          const res = overlapResolutions[oi];
          if (res) {
            const otherJob = o.job1Index === jobIndex ? o.job2 : o.job1;
            let note = `${OVERLAP_LABELS[res] || res} ‚Äî overlaps with ${otherJob.title} at ${otherJob.facility}`;
            if (res === 'prn' && overlapPrnShifts[oi]) {
              note += ` (avg ${overlapPrnShifts[oi]} shifts/week)`;
            }
            notes.push(note);
          }
        }
      });
      return notes;
    }

    // ==================== PDF & DOCX EXTRACTION ====================
    async function extractPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    async function extractDOCXFile(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    // ==================== SCORE RING COMPONENT ====================
    function ScoreRing({ score, size = 90, strokeWidth = 8 }) {
      const radius = (size - strokeWidth) / 2;
      const circumference = radius * 2 * Math.PI;
      const offset = circumference - (score / 100) * circumference;
      const color = score >= 80 ? '#16a34a' : score >= 60 ? '#2563eb' : score >= 40 ? '#d97706' : '#dc2626';
      return (
        <svg width={size} height={size} className="transform -rotate-90">
          <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke="#e5e7eb" strokeWidth={strokeWidth} />
          <circle cx={size/2} cy={size/2} r={radius} fill="none" stroke={color} strokeWidth={strokeWidth}
            strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="score-ring" />
          <text x={size/2} y={size/2} textAnchor="middle" dy="6" className="transform rotate-90" style={{transformOrigin:'center', fontSize: size > 70 ? '22px' : '16px', fontWeight: 700, fill: color}}>
            {score}
          </text>
        </svg>
      );
    }

    // ==================== WORD EXPORT (Zero Dependencies) ====================
    async function exportFullDOCX(data, additionalData, companyName, companyLogo, scoreResult, overlaps, overlapResolutions, overlapPrnShifts) {
      const name = data?.personalInfo?.fullName || 'Candidate';
      const allLicenses = dedupLicenses(data?.licenses, additionalData?.licenses);
      const allCertObjs = dedupCerts(data?.certifications, additionalData?.certifications);
      const allCerts = allCertObjs.map(c => c.name).filter(Boolean);
      const licenseStates = allLicenses.map(l => l.state).filter(Boolean);
      const hasCompact = allLicenses.some(l => l.compact);

      const sc = scoreResult?.total || 0;
      const scoreColor = sc >= 80 ? '#16a34a' : sc >= 60 ? '#2563eb' : sc >= 40 ? '#d97706' : '#dc2626';
      const scoreLabel = sc >= 80 ? 'Strong candidate - submit with confidence' : sc >= 60 ? 'Solid candidate - review pay/location fit' : sc >= 40 ? 'Needs work - check certs and license gaps' : 'Weak profile - may need additional experience';

      const esc = (s) => (s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      const css = `
        body { font-family: Calibri, Arial, sans-serif; color: #1a1a1a; line-height: 1.5; font-size: 11pt; }
        @page { margin: 0.75in; }
        .page-break { page-break-before: always; }
        .header { text-align: center; margin-bottom: 10px; }
        .company-name { font-size: 15pt; font-weight: bold; color: #1e40af; letter-spacing: 2px; text-transform: uppercase; }
        .candidate-name { font-size: 18pt; font-weight: bold; margin: 6px 0 2px 0; }
        .contact-info { font-size: 10pt; color: #666; }
        .highlight-box { background-color: #1e40af; color: white; padding: 8px 14px; margin: 10px 0; font-size: 10pt; }
        .highlight-box b { font-weight: 700; }
        .score-inline { background: ${scoreColor}; color: white; padding: 1px 6px; font-weight: bold; }
        .section-header { font-size: 11.5pt; font-weight: bold; color: #1e40af; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #1e40af; padding-bottom: 2px; margin: 14px 0 6px 0; }
        .job-block { margin-bottom: 10px; }
        .job-title { font-weight: bold; font-size: 11pt; }
        .job-facility { color: #1e40af; font-size: 10.5pt; }
        .job-dates { color: #888; font-size: 9.5pt; }
        .job-meta { font-size: 9pt; color: #999; font-style: italic; background: #f9fafb; padding: 2px 6px; margin: 2px 0; }
        .job-resp { font-size: 10pt; margin: 1px 0 1px 14px; }
        .charge-exp { color: #7c3aed; font-size: 9.5pt; margin-left: 14px; font-weight: 600; }
        .overlap-note { color: #b45309; font-size: 9pt; font-style: italic; margin-left: 14px; }
        .lic-badge { display: inline; background: #dbeafe; color: #1e40af; padding: 1px 5px; font-weight: bold; font-size: 9.5pt; }
        .compact-badge { color: #16a34a; font-weight: 600; font-size: 9pt; }
        .cert-tag { display: inline; background: #f3f4f6; padding: 1px 6px; font-size: 9.5pt; margin-right: 4px; }
        .bullet { font-size: 10.5pt; margin: 2px 0 2px 10px; }
        table.tbl { width: 100%; border-collapse: collapse; font-size: 10pt; }
        table.tbl td, table.tbl th { border: 1px solid #ccc; padding: 4px 7px; }
        table.tbl th { background: #eef2ff; color: #1e40af; font-weight: 600; text-align: left; }
        .footer { text-align: center; font-size: 8pt; color: #bbb; margin-top: 16px; border-top: 1px solid #eee; padding-top: 4px; }
      `;

      // PAGE 1: RESUME PROFILE
      let p1 = '';
      if (companyName) p1 += '<div class="header"><span class="company-name">' + esc(companyName) + '</span></div>';
      p1 += '<div class="candidate-name">' + esc(name) + '</div>';
      const cp = [data?.personalInfo?.phone, data?.personalInfo?.email, data?.personalInfo?.location].filter(Boolean);
      if (cp.length) p1 += '<div class="contact-info">' + cp.map(esc).join(' &nbsp;|&nbsp; ') + '</div>';

      p1 += '<div class="highlight-box">';
      p1 += '<b>' + esc(String(data?.yearsExperience || '-')) + '</b> Years Exp &nbsp; ';
      p1 += '<b>' + esc(data?.primarySpecialty || '-') + '</b> &nbsp; ';
      p1 += 'Licensed: <b>' + esc(licenseStates.join(', ') || '-') + (hasCompact ? ' (Compact)' : '') + '</b> &nbsp; ';
      p1 += 'Certs: <b>' + esc(allCerts.slice(0, 6).join(', ') || '-') + '</b>';
      if (scoreResult) p1 += ' &nbsp; Score: <span class="score-inline">' + scoreResult.total + '/100</span>';
      p1 += '</div>';

      if (scoreResult) p1 += '<div style="font-size:9.5pt;color:' + scoreColor + ';margin-bottom:6px;"><i>' + esc(scoreLabel) + '</i></div>';

      if (additionalData?.summaryBullets?.some(b => b)) {
        additionalData.summaryBullets.filter(b => b).forEach(b => { p1 += '<div class="bullet">&bull; ' + esc(b) + '</div>'; });
      }

      p1 += '<div class="section-header">Credentials &amp; Education</div>';
      if (allLicenses.length) {
        p1 += '<div style="margin-bottom:4px;"><b style="font-size:10pt;">Licenses</b></div>';
        allLicenses.forEach(lic => {
          p1 += '<div style="margin:1px 0 1px 8px;">';
          p1 += '<span class="lic-badge">' + esc(lic.state) + '</span> ' + esc(lic.type || 'RN');
          if (lic.compact) p1 += ' <span class="compact-badge">Compact</span>';
          const det = [lic.licenseNumber ? '#' + lic.licenseNumber : '', lic.expirationDate ? 'Exp: ' + lic.expirationDate : ''].filter(Boolean).join(' | ');
          if (det) p1 += ' <span style="color:#888;font-size:9pt;">' + esc(det) + '</span>';
          p1 += '</div>';
        });
      }
      if (allCerts.length) {
        p1 += '<div style="margin:6px 0 3px 0;"><b style="font-size:10pt;">Certifications</b></div>';
        p1 += '<div style="margin-left:8px;">';
        allCertObjs.filter(c => c.name).forEach(c => { p1 += '<span class="cert-tag">' + esc(c.name) + '</span> '; });
        p1 += '</div>';
      }
      if (data?.education) {
        p1 += '<div style="margin:6px 0 3px 0;"><b style="font-size:10pt;">Education</b></div>';
        p1 += '<div style="margin-left:8px;font-size:10pt;">' + esc(data.education.degree || '') + ' - ' + esc(data.education.school || '');
        if (data.education.graduationDate) p1 += ' <span style="color:#888;">(' + esc(data.education.graduationDate) + ')</span>';
        p1 += '</div>';
      }

      p1 += '<div class="section-header">Work History</div>';
      (data?.workHistory || []).forEach((job, i) => {
        p1 += '<div class="job-block">';
        p1 += '<div><span class="job-title">' + esc(job.title) + '</span> <span class="job-dates">' + esc(job.startDate) + ' - ' + esc(job.endDate) + '</span></div>';
        p1 += '<div class="job-facility">' + esc(job.facility) + ' <span style="color:#888;">- ' + esc(job.city) + ', ' + esc(job.state) + '</span></div>';
        if (job.hospitalData) {
          p1 += '<div class="job-meta">' + job.hospitalData.beds + ' beds | ' + esc(job.hospitalData.traumaLevel) + ' | ' + (job.hospitalData.teaching ? 'Teaching' : 'Non-Teaching') + ' | ' + esc(job.hospitalData.emr) + '</div>';
        }
        (job.responsibilities || []).forEach(r => { p1 += '<div class="job-resp">&bull; ' + esc(r) + '</div>'; });
        if (job.chargeExperience) p1 += '<div class="charge-exp">* Charge Nurse Experience</div>';
        const notes = getOverlapNoteForJob(i, overlaps || [], overlapResolutions || {}, overlapPrnShifts || {});
        notes.forEach(n => { p1 += '<div class="overlap-note">! ' + esc(n) + '</div>'; });
        p1 += '</div>';
      });

      // PAGE 2: SKILLS CHECKLIST
      let p2 = '<div class="page-break"></div>';
      if (companyName) p2 += '<div class="header"><span class="company-name">' + esc(companyName) + ' - SKILLS CHECKLIST</span></div>';
      p2 += '<div style="font-size:13pt;font-weight:bold;margin-bottom:3px;">Skills Checklist for ' + esc(name) + '</div>';
      p2 += '<div style="font-size:10pt;margin-bottom:10px;">Primary Specialty: ' + esc(data?.primarySpecialty || '-') + '</div>';
      const sk = additionalData?.skills || {};
      const cats = { 'Clinical Skills': sk.clinical || [], 'Technical Skills': sk.technical || [], 'Equipment': sk.equipment || [], 'Patient Populations': sk.populations || [], 'Documentation': sk.documentation || [], 'Other': sk.other || [] };
      p2 += '<table class="tbl"><tr><th>Category</th><th>Skills</th></tr>';
      Object.entries(cats).forEach(([c, items]) => { if (items.length) p2 += '<tr><td style="font-weight:600;width:25%;">' + esc(c) + '</td><td>' + items.map(esc).join(', ') + '</td></tr>'; });
      p2 += '</table>';

      // PAGE 3: CERTIFICATIONS
      let p3 = '<div class="page-break"></div>';
      if (companyName) p3 += '<div class="header"><span class="company-name">' + esc(companyName) + ' - CERTIFICATIONS</span></div>';
      p3 += '<div style="font-size:13pt;font-weight:bold;margin-bottom:10px;">Certifications for ' + esc(name) + '</div>';
      p3 += '<table class="tbl"><tr><th>Certification</th><th>Issuing Body</th><th>Number</th><th>Issue Date</th><th>Expiration</th></tr>';
      allCertObjs.filter(c => c.name).forEach(cert => {
        p3 += '<tr><td style="font-weight:600;">' + esc(cert.name) + '</td><td>' + esc(cert.issuingBody || '-') + '</td><td>' + esc(cert.certNumber || '-') + '</td><td>' + esc(cert.issueDate || '-') + '</td><td>' + esc(cert.expirationDate || '-') + '</td></tr>';
      });
      p3 += '</table>';

      // PAGE 4: LICENSE VERIFICATION
      let p4 = '<div class="page-break"></div>';
      if (companyName) p4 += '<div class="header"><span class="company-name">' + esc(companyName) + ' - LICENSE VERIFICATION</span></div>';
      p4 += '<div style="font-size:13pt;font-weight:bold;margin-bottom:10px;">License Verification for ' + esc(name) + '</div>';
      allLicenses.forEach(lic => {
        p4 += '<div style="margin-bottom:8px;">';
        p4 += '<div style="font-weight:bold;font-size:11.5pt;">' + esc(lic.state || '') + ' - ' + esc(lic.type || 'RN');
        if (lic.compact) p4 += ' <span class="compact-badge">(COMPACT)</span>';
        p4 += '</div>';
        if (lic.licenseNumber) p4 += '<div style="margin-left:10px;font-size:10pt;">License #: ' + esc(lic.licenseNumber) + '</div>';
        if (lic.issueDate) p4 += '<div style="margin-left:10px;font-size:10pt;color:#666;">Issue Date: ' + esc(lic.issueDate) + '</div>';
        if (lic.expirationDate) p4 += '<div style="margin-left:10px;font-size:10pt;color:#666;">Expiration: ' + esc(lic.expirationDate) + '</div>';
        p4 += '</div>';
      });
      if (additionalData?.nursysLink) {
        p4 += '<div style="margin-top:14px;"><b>Nursys Verification Link:</b> <span style="color:#2563eb;">' + esc(additionalData.nursysLink) + '</span></div>';
      }

      const footer = '<div class="footer">Profile Builder Pro - ' + new Date().toLocaleDateString() + '</div>';

      const html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>' + css + '</style></head><body>' + p1 + footer + p2 + footer + p3 + footer + p4 + footer + '</body></html>';

      try {
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const fileName = (name || 'candidate').replace(/[^a-zA-Z0-9]/g, '_') + '_Profile_' + new Date().toISOString().slice(0,10) + '.doc';
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('Export Error:', err);
        alert('Error saving document: ' + err.message);
      }
    }

    // ==================== MAIN APP ====================
    function App() {
      const [step, setStep] = useState('input');
      const [resumeText, setResumeText] = useState('');
      const [extractedData, setExtractedData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [companyName, setCompanyName] = useState('');
      const [companyLogo, setCompanyLogo] = useState(null);
      const [activeTab, setActiveTab] = useState('summary');
      const [scoreResult, setScoreResult] = useState(null);
      const [overlaps, setOverlaps] = useState([]);
      const [overlapResolutions, setOverlapResolutions] = useState({});
      const [overlapPrnShifts, setOverlapPrnShifts] = useState({});
      const fileInputRef = useRef(null);
      const logoInputRef = useRef(null);

      const [additionalData, setAdditionalData] = useState({
        summaryBullets: ['', '', '', ''],
        licenses: [],
        certifications: [],
        nursysLink: '',
        driversLicense: { state: '', number: '', expiration: '' },
        references: [
          { name: '', title: '', relationship: '', phone: '', email: '' },
          { name: '', title: '', relationship: '', phone: '', email: '' },
          { name: '', title: '', relationship: '', phone: '', email: '' },
        ],
        skills: { patientCare: [], technical: [], equipment: [], documentation: [] },
      });

      // File upload handler
      const handleFileUpload = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setError('');
        try {
          let text = '';
          if (file.type === 'application/pdf') text = await extractPDF(file);
          else if (file.name.endsWith('.docx')) text = await extractDOCXFile(file);
          else text = await file.text();
          setResumeText(text);
        } catch (err) {
          setError('Could not read file: ' + err.message);
        }
      };

      // Logo upload
      const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => setCompanyLogo(ev.target.result);
        reader.readAsDataURL(file);
      };

      // Extract resume via API
      const handleExtract = async () => {
        if (!resumeText.trim()) { setError('Please paste or upload a resume first'); return; }
        setLoading(true);
        setError('');
        try {
          const response = await fetch('/api/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ resumeText })
          });
          const result = await response.json();
          if (result.error) throw new Error(result.error);

          // Enrich with hospital data and unit templates
          if (result.workHistory) {
            result.workHistory = result.workHistory.map(job => {
              const hd = matchHospital(job.facility);
              const unitType = detectUnitType(job.title, job.unit);
              const template = unitType ? UNIT_TEMPLATES[unitType] : null;
              return {
                ...job,
                hospitalData: hd,
                detectedUnit: unitType,
                responsibilities: job.responsibilities?.length > 0 ? job.responsibilities : (template ? template.responsibilities : [])
              };
            });
          }

          // Pre-populate additional data from extraction
          const newAdditional = { ...additionalData };
          if (result.licenses) {
            newAdditional.licenses = result.licenses.map(l => ({
              state: l.state || '', type: l.type || 'RN', compact: l.compact || false,
              licenseNumber: l.licenseNumber || '', issueDate: l.issueDate || '', expirationDate: l.expirationDate || ''
            }));
          }
          if (result.certifications) {
            newAdditional.certifications = result.certifications.map(c => ({
              name: typeof c === 'string' ? c : (c.name || ''),
              issuingBody: c.issuingBody || '', certNumber: c.certNumber || '',
              issueDate: c.issueDate || '', expirationDate: c.expirationDate || ''
            }));
          }
          setAdditionalData(newAdditional);

          // Detect overlaps
          const detected = detectOverlaps(result.workHistory || []);
          setOverlaps(detected);

          // Calculate score
          const score = calculateScore(result, newAdditional);
          setScoreResult(score);

          setExtractedData(result);
          setStep('edit');
        } catch (err) {
          setError(err.message || 'Extraction failed. Check API key and try again.');
        }
        setLoading(false);
      };

      // Update score when additional data changes
      useEffect(() => {
        if (extractedData) {
          const score = calculateScore(extractedData, additionalData);
          setScoreResult(score);
        }
      }, [additionalData, extractedData]);

      // ===== INPUT STEP =====
      if (step === 'input') {
        return (
          <div className="max-w-3xl mx-auto p-6">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900">Profile Builder <span className="text-blue-600">Pro</span></h1>
              <p className="text-gray-500 mt-1">AI-powered nursing candidate profiles</p>
            </div>

            {/* Company Branding */}
            <div className="bg-white rounded-xl border border-gray-200 p-6 mb-6">
              <h2 className="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4">Company Branding</h2>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">Company Name</label>
                  <input type="text" value={companyName} onChange={e => setCompanyName(e.target.value)}
                    placeholder="e.g. Triage Staffing" className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">Company Logo</label>
                  <div className="flex items-center gap-3">
                    <button onClick={() => logoInputRef.current?.click()}
                      className="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium text-gray-700 transition">
                      {companyLogo ? '‚úì Logo Uploaded' : 'Upload Logo'}
                    </button>
                    {companyLogo && <img src={companyLogo} alt="Logo" className="h-8 object-contain" />}
                    <input ref={logoInputRef} type="file" accept="image/*" onChange={handleLogoUpload} className="hidden" />
                  </div>
                </div>
              </div>
            </div>

            {/* Resume Input */}
            <div className="bg-white rounded-xl border border-gray-200 p-6 mb-6">
              <h2 className="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-4">Resume Input</h2>
              <div className="flex gap-3 mb-4">
                <button onClick={() => fileInputRef.current?.click()}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                  Upload PDF / DOCX
                </button>
                <input ref={fileInputRef} type="file" accept=".pdf,.docx,.doc,.txt" onChange={handleFileUpload} className="hidden" />
                <span className="text-gray-400 self-center text-sm">or paste below</span>
              </div>
              <textarea value={resumeText} onChange={e => setResumeText(e.target.value)}
                placeholder="Paste the full nurse resume text here..."
                className="w-full h-64 px-4 py-3 border border-gray-300 rounded-lg text-sm resize-none" />
            </div>

            {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">{error}</div>}

            <button onClick={handleExtract} disabled={loading}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold text-lg hover:bg-blue-700 disabled:opacity-50 transition">
              {loading ? 'Extracting...' : 'Extract & Build Profile'}
            </button>
          </div>
        );
      }

      // ===== EDIT STEP =====
      const tabs = [
        { id: 'summary', label: 'Summary' },
        { id: 'licenses', label: 'Licenses' },
        { id: 'certifications', label: 'Certifications' },
        { id: 'workhistory', label: 'Work History' },
        { id: 'skills', label: 'Skills' },
        { id: 'references', label: 'üîí References' },
        { id: 'preview', label: 'üëÅ Preview' },
      ];

      const updateAdditional = (path, value) => {
        setAdditionalData(prev => {
          const next = JSON.parse(JSON.stringify(prev));
          const keys = path.split('.');
          let obj = next;
          for (let i = 0; i < keys.length - 1; i++) {
            if (keys[i].match(/^\d+$/)) keys[i] = parseInt(keys[i]);
            obj = obj[keys[i]];
          }
          const lastKey = keys[keys.length - 1].match(/^\d+$/) ? parseInt(keys[keys.length - 1]) : keys[keys.length - 1];
          obj[lastKey] = value;
          return next;
        });
      };

      const addLicense = () => {
        setAdditionalData(prev => ({
          ...prev,
          licenses: [...prev.licenses, { state: '', type: 'RN', compact: false, licenseNumber: '', issueDate: '', expirationDate: '' }]
        }));
      };

      const addCert = () => {
        setAdditionalData(prev => ({
          ...prev,
          certifications: [...prev.certifications, { name: '', issuingBody: '', certNumber: '', issueDate: '', expirationDate: '' }]
        }));
      };

      const addReference = () => {
        setAdditionalData(prev => ({
          ...prev,
          references: [...prev.references, { name: '', title: '', relationship: '', phone: '', email: '' }]
        }));
      };

      return (
        <div className="max-w-6xl mx-auto p-4">
          {/* Header Bar */}
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              {companyLogo && <img src={companyLogo} alt="Logo" className="h-8 object-contain" />}
              <h1 className="text-xl font-bold text-gray-900">Profile Builder <span className="text-blue-600">Pro</span></h1>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setStep('input')} className="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg">
                ‚Üê New Resume
              </button>
              <button onClick={async () => { try { await exportFullDOCX(extractedData, additionalData, companyName, companyLogo, scoreResult, overlaps, overlapResolutions, overlapPrnShifts); } catch(e) { console.error(e); alert('DOCX save error: ' + e.message); } }}
                className="px-4 py-1.5 text-sm bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                Download DOCX
              </button>
            </div>
          </div>

          {/* Overlap Warnings */}
          {overlaps.length > 0 && (() => {
            const allResolved = overlaps.every((_, i) => overlapResolutions[i]);
            return (
            <div className={`rounded-xl p-4 mb-4 border ${allResolved ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300 overlap-warning'}`}>
              <h3 className={`font-semibold mb-2 ${allResolved ? 'text-green-800' : 'text-amber-800'}`}>
                {allResolved ? '‚úì All Overlapping Dates Clarified' : '‚ö† Overlapping Employment Dates Detected'}
              </h3>
              {overlaps.map((o, i) => {
                const resolved = !!overlapResolutions[i];
                return (
                <div key={i} className={`mb-3 last:mb-0 p-2 rounded-lg ${resolved ? 'bg-green-100/50' : ''}`}>
                  <p className={`text-sm ${resolved ? 'text-green-700' : 'text-amber-700'}`}>
                    {resolved && <span className="mr-1">‚úì</span>}
                    <strong>{o.job1.title}</strong> at {o.job1.facility} ({o.job1.startDate} ‚Äì {o.job1.endDate}) overlaps with{' '}
                    <strong>{o.job2.title}</strong> at {o.job2.facility} ({o.job2.startDate} ‚Äì {o.job2.endDate})
                  </p>
                  <div className="mt-2 flex gap-2 items-center flex-wrap">
                    <span className={`text-xs font-medium ${resolved ? 'text-green-600' : 'text-amber-600'}`}>Clarification:</span>
                    <select value={overlapResolutions[i] || ''} onChange={e => setOverlapResolutions(prev => ({ ...prev, [i]: e.target.value }))}
                      className={`text-xs border rounded px-2 py-1 bg-white ${resolved ? 'border-green-300' : 'border-amber-300'}`}>
                      <option value="">Select reason...</option>
                      <option value="prn">PRN / Per Diem alongside travel</option>
                      <option value="staff_and_travel">Staff position + travel assignment</option>
                      <option value="transition">Transition period between jobs</option>
                      <option value="error">Date error on resume (needs correction)</option>
                    </select>
                    {overlapResolutions[i] === 'prn' && (
                      <input type="text" value={overlapPrnShifts[i] || ''} 
                        onChange={e => setOverlapPrnShifts(prev => ({ ...prev, [i]: e.target.value }))}
                        placeholder="Avg shifts/week?" className="text-xs border border-amber-300 rounded px-2 py-1 w-36" />
                    )}
                    {resolved && overlapResolutions[i] !== 'prn' && (
                      <span className="text-xs text-green-600 italic">{OVERLAP_LABELS[overlapResolutions[i]]}</span>
                    )}
                    {resolved && overlapResolutions[i] === 'prn' && overlapPrnShifts[i] && (
                      <span className="text-xs text-green-600 italic">PRN ‚Äî {overlapPrnShifts[i]} shifts/week</span>
                    )}
                  </div>
                </div>
              );})}
            </div>
          );})()}

          <div className="grid grid-cols-12 gap-4">
            {/* Left Panel: Score + Tabs */}
            <div className="col-span-5">
              {/* Score Card */}
              {scoreResult && (
                <div className="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                  <div className="flex items-center gap-4">
                    <ScoreRing score={scoreResult.total} size={80} />
                    <div>
                      <h3 className="font-semibold text-gray-800">Placement Score</h3>
                      <p className="text-xs text-gray-500 capitalize">{scoreResult.specialty || 'General'} Specialty</p>
                      <p className="text-xs mt-1">
                        {scoreResult.total >= 80 ? <span className="text-green-600 font-medium">Strong candidate ‚Äî submit with confidence</span> :
                         scoreResult.total >= 60 ? <span className="text-blue-600 font-medium">Solid candidate ‚Äî review pay/location fit</span> :
                         scoreResult.total >= 40 ? <span className="text-amber-600 font-medium">Needs work ‚Äî check certs & license gaps</span> :
                         <span className="text-red-600 font-medium">Weak profile ‚Äî may need additional experience</span>}
                      </p>
                    </div>
                  </div>
                  <div className="grid grid-cols-5 gap-1 mt-3">
                    {[
                      { label: 'Exp', val: scoreResult.scores.years },
                      { label: 'Certs', val: scoreResult.scores.certs },
                      { label: 'License', val: scoreResult.scores.license },
                      { label: 'Facility', val: scoreResult.scores.facility },
                      { label: 'Charge', val: scoreResult.scores.chargeExp },
                    ].map(s => (
                      <div key={s.label} className="text-center">
                        <div className="text-xs text-gray-500">{s.label}</div>
                        <div className={`text-sm font-bold ${s.val >= 70 ? 'text-green-600' : s.val >= 40 ? 'text-amber-600' : 'text-red-500'}`}>{Math.round(s.val)}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Tabs */}
              <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div className="flex border-b overflow-x-auto">
                  {tabs.map(tab => (
                    <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                      className={`px-3 py-2 text-xs font-medium whitespace-nowrap transition ${activeTab === tab.id ? 'tab-active bg-blue-50' : 'text-gray-500 hover:text-gray-700'}`}>
                      {tab.label}
                    </button>
                  ))}
                </div>

                <div className="p-4 max-h-[600px] overflow-y-auto">
                  {/* SUMMARY TAB */}
                  {activeTab === 'summary' && (
                    <div className="space-y-3">
                      <h3 className="font-semibold text-sm text-gray-800">Quick Summary Bullets</h3>
                      <p className="text-xs text-gray-500">These appear in the blue highlight box at the top of the profile</p>
                      {additionalData.summaryBullets.map((bullet, i) => (
                        <input key={i} type="text" value={bullet} onChange={e => updateAdditional(`summaryBullets.${i}`, e.target.value)}
                          placeholder={`Summary point ${i + 1}...`} className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                      ))}
                      <div className="border-t pt-3 mt-3">
                        <label className="block text-sm font-medium text-gray-600 mb-1">Nursys License Verification</label>
                        <p className="text-xs text-gray-400 mb-2">Auto-generates a Nursys lookup link from the nurse's name and license state</p>
                        {extractedData?.personalInfo?.fullName && (() => {
                          const nameParts = (extractedData.personalInfo.fullName || '').split(' ');
                          const firstName = nameParts[0] || '';
                          const lastName = nameParts[nameParts.length - 1] || '';
                          const primaryState = (additionalData?.licenses?.[0]?.state || extractedData?.licenses?.[0]?.state || '').toUpperCase();
                          const nursysUrl = `https://www.nursys.com/LLV/LLVSearch.aspx`;
                          return (
                            <div className="space-y-2">
                              <div className="bg-blue-50 rounded-lg p-3 flex items-center justify-between">
                                <div>
                                  <p className="text-xs text-blue-700 font-medium">Quick Lookup: {firstName} {lastName}{primaryState ? ` ‚Äî ${primaryState}` : ''}</p>
                                  <p className="text-xs text-blue-500">Click to verify on Nursys.com</p>
                                </div>
                                <a href={nursysUrl} target="_blank" rel="noopener noreferrer"
                                  className="px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700">
                                  Open Nursys ‚Üó
                                </a>
                              </div>
                              <input type="text" value={additionalData.nursysLink} onChange={e => updateAdditional('nursysLink', e.target.value)}
                                placeholder="Paste Nursys verification URL after lookup..." className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                            </div>
                          );
                        })()}
                        {!extractedData?.personalInfo?.fullName && (
                          <input type="text" value={additionalData.nursysLink} onChange={e => updateAdditional('nursysLink', e.target.value)}
                            placeholder="https://www.nursys.com/..." className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                        )}
                      </div>
                      <div className="border-t pt-3 mt-3">
                        <h4 className="text-sm font-medium text-gray-600 mb-2">Driver's License</h4>
                        <div className="grid grid-cols-3 gap-2">
                          <input type="text" value={additionalData.driversLicense.state} onChange={e => updateAdditional('driversLicense.state', e.target.value)}
                            placeholder="State" className="px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                          <input type="text" value={additionalData.driversLicense.number} onChange={e => updateAdditional('driversLicense.number', e.target.value)}
                            placeholder="DL Number" className="px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                          <input type="text" value={additionalData.driversLicense.expiration} onChange={e => updateAdditional('driversLicense.expiration', e.target.value)}
                            placeholder="Exp Date" className="px-3 py-2 border border-gray-300 rounded-lg text-sm" />
                        </div>
                      </div>
                    </div>
                  )}

                  {/* LICENSES TAB */}
                  {activeTab === 'licenses' && (
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <h3 className="font-semibold text-sm text-gray-800">Nursing Licenses</h3>
                        <button onClick={addLicense} className="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded font-medium hover:bg-blue-100">+ Add License</button>
                      </div>
                      {additionalData.licenses.map((lic, i) => (
                        <div key={i} className="border border-gray-200 rounded-lg p-3 space-y-2">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-semibold text-gray-500">License {i + 1}</span>
                            <button onClick={() => setAdditionalData(prev => ({ ...prev, licenses: prev.licenses.filter((_, j) => j !== i) }))}
                              className="ml-auto text-xs text-red-500 hover:text-red-700">Remove</button>
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <input type="text" value={lic.state} onChange={e => updateAdditional(`licenses.${i}.state`, e.target.value)}
                              placeholder="State (e.g. FL)" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <select value={lic.type} onChange={e => updateAdditional(`licenses.${i}.type`, e.target.value)}
                              className="px-2 py-1.5 border border-gray-300 rounded text-sm">
                              <option value="RN">RN</option><option value="LPN">LPN</option><option value="APRN">APRN</option>
                            </select>
                            <label className="flex items-center gap-2 text-sm">
                              <input type="checkbox" checked={lic.compact} onChange={e => updateAdditional(`licenses.${i}.compact`, e.target.checked)} />
                              Compact
                            </label>
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <input type="text" value={lic.licenseNumber} onChange={e => updateAdditional(`licenses.${i}.licenseNumber`, e.target.value)}
                              placeholder="License #" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={lic.issueDate} onChange={e => updateAdditional(`licenses.${i}.issueDate`, e.target.value)}
                              placeholder="Issue Date" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={lic.expirationDate} onChange={e => updateAdditional(`licenses.${i}.expirationDate`, e.target.value)}
                              placeholder="Exp Date" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* CERTIFICATIONS TAB */}
                  {activeTab === 'certifications' && (
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <h3 className="font-semibold text-sm text-gray-800">Certifications</h3>
                        <button onClick={addCert} className="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded font-medium hover:bg-blue-100">+ Add Cert</button>
                      </div>
                      {additionalData.certifications.map((cert, i) => (
                        <div key={i} className="border border-gray-200 rounded-lg p-3 space-y-2">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-semibold text-gray-500">Cert {i + 1}</span>
                            <button onClick={() => setAdditionalData(prev => ({ ...prev, certifications: prev.certifications.filter((_, j) => j !== i) }))}
                              className="ml-auto text-xs text-red-500 hover:text-red-700">Remove</button>
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <input type="text" value={cert.name} onChange={e => updateAdditional(`certifications.${i}.name`, e.target.value)}
                              placeholder="Cert Name (e.g. BLS)" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={cert.issuingBody} onChange={e => updateAdditional(`certifications.${i}.issuingBody`, e.target.value)}
                              placeholder="Issuing Body (e.g. AHA)" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <input type="text" value={cert.certNumber} onChange={e => updateAdditional(`certifications.${i}.certNumber`, e.target.value)}
                              placeholder="Cert #" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={cert.issueDate} onChange={e => updateAdditional(`certifications.${i}.issueDate`, e.target.value)}
                              placeholder="Issue Date" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={cert.expirationDate} onChange={e => updateAdditional(`certifications.${i}.expirationDate`, e.target.value)}
                              placeholder="Exp Date" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* WORK HISTORY TAB */}
                  {activeTab === 'workhistory' && (
                    <div className="space-y-3">
                      <h3 className="font-semibold text-sm text-gray-800">Work History</h3>
                      {(extractedData?.workHistory || []).map((job, i) => (
                        <div key={i} className="border border-gray-200 rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-medium text-sm">{job.title} ‚Äî {job.facility}</span>
                            {job.hospitalData && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">‚úì Enriched</span>}
                          </div>
                          <p className="text-xs text-gray-500">{job.startDate} ‚Äì {job.endDate} | {job.city}, {job.state}</p>
                          {job.hospitalData && (
                            <p className="text-xs text-gray-400 mt-1">{job.hospitalData.beds} beds | {job.hospitalData.traumaLevel} | {job.hospitalData.teaching ? 'Teaching' : 'Non-Teaching'} | {job.hospitalData.emr}</p>
                          )}
                          {job.chargeExperience && <p className="text-xs text-purple-600 mt-1">‚òÖ Charge Nurse Experience</p>}
                          <div className="mt-2">
                            <p className="text-xs text-gray-500 mb-1">Responsibilities:</p>
                            {(job.responsibilities || []).map((r, j) => (
                              <p key={j} className="text-xs text-gray-600 ml-2">‚Ä¢ {r}</p>
                            ))}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* SKILLS TAB */}
                  {activeTab === 'skills' && (
                    <div className="space-y-3">
                      <h3 className="font-semibold text-sm text-gray-800">Skills Checklist</h3>
                      <p className="text-xs text-gray-500">Auto-generated from specialty. Add custom skills below.</p>
                      {extractedData?.primarySpecialty && (() => {
                        const spec = extractedData.primarySpecialty.toLowerCase();
                        const unitKey = Object.keys(UNIT_TEMPLATES).find(k => spec.includes(k));
                        const template = unitKey ? UNIT_TEMPLATES[unitKey] : null;
                        if (!template) return null;
                        return (
                          <div className="bg-blue-50 rounded-lg p-3">
                            <p className="text-xs font-semibold text-blue-700 mb-2">Auto-generated for {extractedData.primarySpecialty}:</p>
                            {template.responsibilities.map((r, i) => (
                              <p key={i} className="text-xs text-blue-600 ml-2">‚úì {r}</p>
                            ))}
                            <p className="text-xs text-blue-500 mt-2">Typical Ratio: {template.typicalRatio}</p>
                          </div>
                        );
                      })()}
                      {['patientCare', 'technical', 'equipment', 'documentation'].map(cat => (
                        <div key={cat} className="border border-gray-200 rounded-lg p-3">
                          <label className="text-xs font-medium text-gray-600 capitalize mb-1 block">{cat.replace(/([A-Z])/g, ' $1')}</label>
                          <textarea value={(additionalData.skills[cat] || []).join('\n')}
                            onChange={e => updateAdditional(`skills.${cat}`, e.target.value.split('\n').filter(s => s.trim()))}
                            placeholder="One skill per line..." className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm h-16 resize-none" />
                        </div>
                      ))}
                    </div>
                  )}

                  {/* REFERENCES TAB - INTERNAL ONLY */}
                  {activeTab === 'references' && (
                    <div className="space-y-3">
                      <div className="flex items-center justify-between">
                        <h3 className="font-semibold text-sm text-gray-800">References</h3>
                        <button onClick={addReference} className="text-xs px-2 py-1 bg-blue-50 text-blue-600 rounded font-medium hover:bg-blue-100">+ Add Reference</button>
                      </div>
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-2">
                        <p className="text-xs text-amber-700 font-medium">üîí Internal Only ‚Äî references are NOT included in the exported profile</p>
                      </div>
                      {additionalData.references.map((ref, i) => (
                        <div key={i} className="border border-gray-200 rounded-lg p-3 space-y-2">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-semibold text-gray-500">Reference {i + 1}</span>
                            {ref.status === 'sent' && <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">üì± Text Sent</span>}
                            {ref.status === 'completed' && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">‚úì Completed</span>}
                            {i >= 3 && <button onClick={() => setAdditionalData(prev => ({ ...prev, references: prev.references.filter((_, j) => j !== i) }))}
                              className="ml-auto text-xs text-red-500 hover:text-red-700">Remove</button>}
                          </div>
                          <div className="grid grid-cols-3 gap-2">
                            <input type="text" value={ref.name} onChange={e => updateAdditional(`references.${i}.name`, e.target.value)}
                              placeholder="Reference Name" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={ref.title} onChange={e => updateAdditional(`references.${i}.title`, e.target.value)}
                              placeholder="Title" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                            <input type="text" value={ref.phone} onChange={e => updateAdditional(`references.${i}.phone`, e.target.value)}
                              placeholder="Phone Number" className="px-2 py-1.5 border border-gray-300 rounded text-sm" />
                          </div>
                          <input type="text" value={ref.relationship} onChange={e => updateAdditional(`references.${i}.relationship`, e.target.value)}
                            placeholder="Relationship (e.g. Charge Nurse, Supervisor)" className="w-full px-2 py-1.5 border border-gray-300 rounded text-sm" />
                          {ref.name && ref.phone && (
                            <button onClick={() => { updateAdditional(`references.${i}.status`, 'sent'); }}
                              className="w-full py-1.5 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 transition">
                              üì± Send Reference Request via Text
                            </button>
                          )}
                          {ref.status === 'sent' && (
                            <p className="text-xs text-gray-400 italic">Reference request sent ‚Äî waiting for response</p>
                          )}
                        </div>
                      ))}
                      <div className="bg-gray-50 rounded-lg p-3 mt-2">
                        <p className="text-xs text-gray-500">üí° <strong>Coming soon:</strong> References will receive an automated text with a link to complete their reference. Responses are stored here automatically.</p>
                      </div>
                    </div>
                  )}

                  {/* PREVIEW TAB */}
                  {activeTab === 'preview' && (
                    <div className="space-y-2">
                      <h3 className="font-semibold text-sm text-gray-800">DOCX Export Preview</h3>
                      <p className="text-xs text-gray-500">Your downloaded DOCX will include these pages:</p>
                      <div className="space-y-2 mt-2">
                        {['Page 1: Resume Profile (with blue highlight box)', 'Page 2: Skills Checklist', 'Page 3: Certifications (formatted)', 'Page 4: License Verification / Nursys'].map((page, i) => (
                          <div key={i} className="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg">
                            <span className="text-xs font-mono text-blue-600">{i + 1}</span>
                            <span className="text-sm text-gray-700">{page.split(': ')[1]}</span>
                          </div>
                        ))}
                        <div className="flex items-center gap-2 px-3 py-2 bg-amber-50 rounded-lg border border-amber-200">
                          <span className="text-xs font-mono text-amber-600">üîí</span>
                          <span className="text-sm text-amber-700">References stored internally ‚Äî not in export</span>
                        </div>
                      </div>
                      <button onClick={async () => { try { await exportFullDOCX(extractedData, additionalData, companyName, companyLogo, scoreResult, overlaps, overlapResolutions, overlapPrnShifts); } catch(e) { console.error(e); alert('DOCX save error: ' + e.message); } }}
                        className="w-full mt-4 py-2 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700 transition">
                        Download Complete Profile Packet (DOCX)
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Right Panel: Live Profile Preview */}
            <div className="col-span-7">
              <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                {/* Company Header */}
                <div className="px-6 py-4 border-b border-gray-100 flex items-center gap-3">
                  {companyLogo && <img src={companyLogo} alt="Logo" className="h-10 object-contain" />}
                  {companyName && <span className="text-lg font-bold text-blue-800 uppercase tracking-wider">{companyName}</span>}
                  {!companyName && !companyLogo && <span className="text-sm text-gray-400 italic">No company branding set</span>}
                </div>

                {/* Candidate Name */}
                <div className="px-6 pt-4 pb-2">
                  <h1 className="text-2xl font-bold text-gray-900">{extractedData?.personalInfo?.fullName || 'Candidate'}</h1>
                  <p className="text-sm text-gray-500 mt-1">
                    {[extractedData?.personalInfo?.phone, extractedData?.personalInfo?.email, extractedData?.personalInfo?.location].filter(Boolean).join(' | ')}
                  </p>
                </div>

                {/* BLUE HIGHLIGHT BOX */}
                {(() => {
                  const dl = dedupLicenses(extractedData?.licenses, additionalData?.licenses);
                  const dc = dedupCerts(extractedData?.certifications, additionalData?.certifications);
                  return (
                <div className="mx-6 mb-4 highlight-box rounded-lg px-5 py-3">
                  <div className="flex flex-wrap gap-x-6 gap-y-1 text-white text-sm">
                    <span><strong>{extractedData?.yearsExperience || '‚Äî'}</strong> Years Exp</span>
                    <span><strong>{extractedData?.primarySpecialty || '‚Äî'}</strong></span>
                    <span>Licensed: <strong>
                      {dl.map(l => l.state).filter(Boolean).join(', ') || '‚Äî'}
                      {dl.some(l => l.compact) ? ' (Compact)' : ''}
                    </strong></span>
                    <span>Certs: <strong>
                      {dc.map(c => c.name).filter(Boolean).slice(0, 5).join(', ') || '‚Äî'}
                    </strong></span>
                    {scoreResult && <span>Score: <strong>{scoreResult.total}/100</strong></span>}
                  </div>
                </div>
                  );
                })()}

                {/* Summary Bullets */}
                {additionalData.summaryBullets.some(b => b) && (
                  <div className="px-6 pb-3">
                    {additionalData.summaryBullets.filter(b => b).map((b, i) => (
                      <p key={i} className="text-sm text-gray-700 mb-1">‚Ä¢ {b}</p>
                    ))}
                  </div>
                )}

                {/* CREDENTIALS & EDUCATION */}
                <div className="px-6 py-3 border-t border-gray-100">
                  <h2 className="text-sm font-bold text-blue-800 uppercase tracking-wide border-b-2 border-blue-800 pb-1 mb-3">Credentials & Education</h2>
                  {(() => {
                    const dl = dedupLicenses(extractedData?.licenses, additionalData?.licenses);
                    const dc = dedupCerts(extractedData?.certifications, additionalData?.certifications);
                    return (
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <h3 className="text-xs font-semibold text-gray-500 mb-1">Licenses</h3>
                      {dl.map((lic, i) => (
                        <div key={i} className="flex items-center gap-2 mb-1">
                          <span className="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded">{lic.state}</span>
                          <span className="text-xs text-gray-700">{lic.type || 'RN'}</span>
                          {lic.compact && <span className="text-xs text-green-600 font-medium">Compact</span>}
                          {lic.expirationDate && <span className="text-xs text-gray-400">Exp: {lic.expirationDate}</span>}
                        </div>
                      ))}
                    </div>
                    <div>
                      <h3 className="text-xs font-semibold text-gray-500 mb-1">Certifications</h3>
                      <div className="flex flex-wrap gap-1">
                        {dc.map((cert, i) => (
                          <span key={i} className="px-2 py-0.5 bg-gray-100 text-gray-700 text-xs rounded font-medium">{cert.name}</span>
                        ))}
                      </div>
                      {extractedData?.education && (
                        <div className="mt-2">
                          <h3 className="text-xs font-semibold text-gray-500 mb-1">Education</h3>
                          <p className="text-xs text-gray-700">{extractedData.education.degree} ‚Äî {extractedData.education.school}</p>
                          {extractedData.education.graduationDate && <p className="text-xs text-gray-400">{extractedData.education.graduationDate}</p>}
                        </div>
                      )}
                    </div>
                  </div>
                    );
                  })()}
                </div>

                {/* WORK HISTORY */}
                <div className="px-6 py-3 border-t border-gray-100">
                  <h2 className="text-sm font-bold text-blue-800 uppercase tracking-wide border-b-2 border-blue-800 pb-1 mb-3">Work History</h2>
                  {(extractedData?.workHistory || []).map((job, i) => (
                    <div key={i} className="mb-4 last:mb-0">
                      <div className="flex items-start justify-between">
                        <div>
                          <p className="font-semibold text-gray-900 text-sm">{job.title}</p>
                          <p className="text-sm text-blue-700">{job.facility} <span className="text-gray-400">‚Äî {job.city}, {job.state}</span></p>
                        </div>
                        <span className="text-xs text-gray-400 whitespace-nowrap">{job.startDate} ‚Äì {job.endDate}</span>
                      </div>
                      {job.hospitalData && (
                        <p className="text-xs text-gray-400 mt-0.5 italic">{job.hospitalData.beds} beds | {job.hospitalData.traumaLevel} | {job.hospitalData.teaching ? 'Teaching' : 'Non-Teaching'} | {job.hospitalData.emr}</p>
                      )}
                      <div className="mt-1">
                        {(job.responsibilities || []).slice(0, 4).map((r, j) => (
                          <p key={j} className="text-xs text-gray-600 ml-3">‚Ä¢ {r}</p>
                        ))}
                      </div>
                      {job.chargeExperience && <p className="text-xs text-purple-600 ml-3 mt-1">‚òÖ Charge Nurse Experience</p>}
                      {/* Overlap notes */}
                      {getOverlapNoteForJob(i, overlaps, overlapResolutions, overlapPrnShifts).map((note, ni) => (
                        <p key={ni} className="text-xs text-amber-600 ml-3 mt-1 italic">‚ö† {note}</p>
                      ))}
                    </div>
                  ))}
                </div>

                {/* References - Internal Only indicator */}
                {additionalData.references.some(r => r.name) && (
                  <div className="px-6 py-2 border-t border-gray-100">
                    <p className="text-xs text-gray-400 italic">üîí {additionalData.references.filter(r => r.name).length} reference(s) on file ‚Äî stored internally</p>
                  </div>
                )}

                <div className="px-6 py-2 bg-gray-50 text-center border-t">
                  <p className="text-xs text-gray-400">Profile Builder Pro ‚Ä¢ {new Date().toLocaleDateString()}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
