<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile Builder Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://unpkg.com/docx@8.2.0/build/index.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    @media print { .no-print { display: none !important; } }
    .section-header { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    .diagonal-bg { background: repeating-linear-gradient(135deg, transparent, transparent 10px, rgba(0,0,0,0.015) 10px, rgba(0,0,0,0.015) 20px); }
  </style>
  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    const SKILLS_BY_SPECIALTY = {
      "OR": ["Circulating", "Scrubbing", "First Assist", "General Surgery", "Orthopedics", "CVOR", "Neurosurgery", "Robotics (Da Vinci)", "Trauma", "GYN", "Urology", "ENT", "Spine"],
      "ICU": ["Ventilator Management", "Arterial Lines", "Central Lines", "Vasopressors/Drips", "CRRT", "IABP", "Impella", "ECMO", "Code Team"],
      "ED": ["Triage", "Trauma", "Pediatric Emergency", "Stroke/STEMI", "Conscious Sedation", "Chest Tubes", "RSI Assist"],
      "Med-Surg": ["Telemetry", "Wound Care", "IV Therapy", "Blood Transfusions", "PCA Pumps", "NG Tubes", "Discharge Planning"],
      "L&D": ["Fetal Monitoring", "High-Risk OB", "C-Section", "Epidural Management", "Pitocin", "Neonatal Resuscitation"],
      "Telemetry": ["Rhythm Interpretation", "12-Lead EKG", "Cardiac Drips", "Post-Cath Care", "Pacemaker/ICD"]
    };

    const CHARTING_SYSTEMS = ["Epic", "Cerner", "Meditech", "CPSI", "Allscripts", "Other"];
    const TRAUMA_LEVELS = ["Trauma Level 1", "Trauma Level 2", "Trauma Level 3", "Non-Trauma", "N/A"];

    async function extractPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    async function extractDOCX(file) {
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      return result.value;
    }

    // COMPACT DOCX Export - All on 1-2 pages in correct order
    async function exportDOCX(data, companyName, additional) {
      const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, BorderStyle, WidthType, AlignmentType, ShadingType, convertInchesToTwip, PageBreak } = window.docx;
      
      const candidateName = data.personalInfo?.fullName || 'Candidate';
      const children = [];
      
      // Helper for blue section headers
      const sectionHeader = (text) => new Paragraph({
        shading: { fill: "0891B2", type: ShadingType.CLEAR },
        children: [new TextRun({ text: `  ${text}`, bold: true, size: 20, color: "FFFFFF" })],
        spacing: { before: 150, after: 80 }
      });
      
      // ===== HEADER =====
      children.push(new Paragraph({
        children: [
          new TextRun({ text: companyName || 'STAFFING AGENCY', bold: true, size: 28, color: "0891B2" }),
          new TextRun({ text: '\t\t\t', size: 20 }),
          new TextRun({ text: candidateName, bold: true, size: 28 }),
        ],
        spacing: { after: 40 }
      }));
      
      // Contact line
      const contact = [data.personalInfo?.phone, data.personalInfo?.email, data.personalInfo?.location].filter(Boolean).join(' | ');
      children.push(new Paragraph({
        children: [new TextRun({ text: contact, size: 18, color: "666666" })],
        alignment: AlignmentType.RIGHT,
        spacing: { after: 100 }
      }));
      
      // Summary bullets
      if (additional?.summaryBullets?.some(b => b)) {
        additional.summaryBullets.filter(b => b).forEach(bullet => {
          children.push(new Paragraph({
            children: [new TextRun({ text: `• ${bullet}`, size: 18 })],
            spacing: { after: 20 }
          }));
        });
        children.push(new Paragraph({ spacing: { after: 80 } }));
      }
      
      // ===== TWO COLUMN LAYOUT using Table =====
      const leftCells = [];
      const rightCells = [];
      
      // LEFT COLUMN CONTENT
      
      // Experience
      leftCells.push(new Paragraph({
        shading: { fill: "0891B2", type: ShadingType.CLEAR },
        children: [new TextRun({ text: " Experience", bold: true, size: 18, color: "FFFFFF" })],
        spacing: { after: 60 }
      }));
      leftCells.push(new Paragraph({
        children: [new TextRun({ text: `Specialties: `, bold: true, size: 17 }), new TextRun({ text: data.primarySpecialty || 'RN', size: 17 })],
        spacing: { after: 30 }
      }));
      leftCells.push(new Paragraph({
        children: [new TextRun({ text: `Years of Experience: `, bold: true, size: 17 }), new TextRun({ text: `${data.yearsExperience || '—'}+ years`, size: 17 })],
        spacing: { after: 30 }
      }));
      leftCells.push(new Paragraph({
        children: [new TextRun({ text: `Charting: `, bold: true, size: 17 }), new TextRun({ text: additional?.primaryCharting || 'Various', size: 17 })],
        spacing: { after: 100 }
      }));
      
      // Licenses & Certs
      leftCells.push(new Paragraph({
        shading: { fill: "0891B2", type: ShadingType.CLEAR },
        children: [new TextRun({ text: " Licenses and Certifications", bold: true, size: 18, color: "FFFFFF" })],
        spacing: { after: 60 }
      }));
      
      additional?.licenseDetails?.filter(l => l.state).forEach(lic => {
        leftCells.push(new Paragraph({
          children: [new TextRun({ text: `${lic.type || 'RN'}, ${lic.state} – Exp. ${lic.expDate || 'N/A'}`, size: 17 })],
          spacing: { after: 20 }
        }));
        if (lic.number) {
          leftCells.push(new Paragraph({
            children: [new TextRun({ text: lic.number, size: 15, color: "666666" })],
            spacing: { after: 30 }
          }));
        }
      });
      
      additional?.certDetails?.filter(c => c.name).forEach(cert => {
        leftCells.push(new Paragraph({
          children: [new TextRun({ text: `${cert.name} (Exp: ${cert.expDate || 'N/A'})`, size: 17 })],
          spacing: { after: 20 }
        }));
      });
      leftCells.push(new Paragraph({ spacing: { after: 80 } }));
      
      // Education
      leftCells.push(new Paragraph({
        shading: { fill: "0891B2", type: ShadingType.CLEAR },
        children: [new TextRun({ text: " Education", bold: true, size: 18, color: "FFFFFF" })],
        spacing: { after: 60 }
      }));
      
      if (data.education) {
        leftCells.push(new Paragraph({
          children: [new TextRun({ text: `Graduation Date: ${data.education.graduationDate || 'N/A'}`, size: 17 })],
          spacing: { after: 20 }
        }));
        leftCells.push(new Paragraph({
          children: [new TextRun({ text: data.education.school || '', size: 17 })],
          spacing: { after: 20 }
        }));
        leftCells.push(new Paragraph({
          children: [new TextRun({ text: data.education.degree || '', size: 17 })],
          spacing: { after: 40 }
        }));
      }
      
      // RIGHT COLUMN - Work History
      rightCells.push(new Paragraph({
        shading: { fill: "0891B2", type: ShadingType.CLEAR },
        children: [new TextRun({ text: " Work History", bold: true, size: 18, color: "FFFFFF" })],
        spacing: { after: 80 }
      }));
      
      additional?.workDetails?.forEach((job, idx) => {
        // Facility header
        rightCells.push(new Paragraph({
          children: [
            new TextRun({ text: `${job.facility || 'Facility'} – ${job.city || ''}, ${job.state || ''}`, bold: true, size: 19 }),
            new TextRun({ text: `\t${job.startDate || ''} – ${job.endDate || 'Present'}`, size: 17, color: "666666" })
          ],
          spacing: { before: idx > 0 ? 120 : 0, after: 30 }
        }));
        
        rightCells.push(new Paragraph({
          children: [new TextRun({ text: job.title || 'Travel RN', size: 17 })],
          spacing: { after: 20 }
        }));
        
        if (job.roleDescription) {
          rightCells.push(new Paragraph({
            children: [new TextRun({ text: job.roleDescription, size: 17 })],
            spacing: { after: 30 }
          }));
        }
        
        // Facility details - compact
        const details = [];
        if (job.totalBeds) details.push(`Total Staffed Beds: ${job.totalBeds}`);
        if (job.traumaLevel || job.facilityType) details.push(`Facility Type: ${[job.traumaLevel, job.facilityType].filter(Boolean).join(' and ')}`);
        if (job.orSuites) details.push(`Number of OR suites: ${job.orSuites}`);
        if (job.robotics) details.push(`Robotics: Yes (${job.roboticsSystem || 'Da Vinci SI'})`);
        if (job.charting) details.push(`Charting System: ${job.charting}`);
        
        details.forEach(d => {
          rightCells.push(new Paragraph({
            children: [new TextRun({ text: d, size: 16 })],
            spacing: { after: 15 }
          }));
        });
        
        if (job.duties) {
          rightCells.push(new Paragraph({
            children: [new TextRun({ text: `Duties: ${job.duties}`, size: 16 })],
            spacing: { after: 40 }
          }));
        }
      });
      
      // Create two-column table
      const table = new Table({
        width: { size: 100, type: WidthType.PERCENTAGE },
        rows: [
          new TableRow({
            children: [
              new TableCell({
                width: { size: 35, type: WidthType.PERCENTAGE },
                borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },
                children: leftCells
              }),
              new TableCell({
                width: { size: 65, type: WidthType.PERCENTAGE },
                borders: { top: { style: BorderStyle.NONE }, bottom: { style: BorderStyle.NONE }, left: { style: BorderStyle.NONE }, right: { style: BorderStyle.NONE } },
                children: rightCells
              })
            ]
          })
        ]
      });
      
      children.push(table);
      
      // Footer
      children.push(new Paragraph({
        children: [new TextRun({ text: `${additional?.companyAddress || ''} | ${additional?.companyPhone || ''}`, size: 16, color: "999999" })],
        alignment: AlignmentType.CENTER,
        spacing: { before: 200 }
      }));
      
      // ===== PAGE 2: References, Skills, Certs, Nursys (if needed) =====
      const hasPage2Content = additional?.references?.some(r => r.name) || additional?.skills?.length || additional?.nursysLink;
      
      if (hasPage2Content) {
        children.push(new Paragraph({ children: [new PageBreak()] }));
        
        // Header for page 2
        children.push(new Paragraph({
          children: [
            new TextRun({ text: companyName || 'STAFFING AGENCY', bold: true, size: 28, color: "0891B2" }),
            new TextRun({ text: `\t\t\t${candidateName}`, bold: true, size: 24 }),
          ],
          spacing: { after: 150 }
        }));
        
        // REFERENCES
        const refs = additional?.references?.filter(r => r.name) || [];
        if (refs.length) {
          children.push(sectionHeader('References'));
          refs.forEach(ref => {
            children.push(new Paragraph({
              children: [
                new TextRun({ text: ref.name, bold: true, size: 19 }),
                ref.title ? new TextRun({ text: ` – ${ref.title}`, size: 18, color: "666666" }) : new TextRun({ text: '' }),
                ref.facility ? new TextRun({ text: ` at ${ref.facility}`, size: 18, color: "666666" }) : new TextRun({ text: '' }),
              ],
              spacing: { after: 20 }
            }));
            children.push(new Paragraph({
              children: [
                new TextRun({ text: [ref.relationship, ref.phone, ref.email].filter(Boolean).join(' | '), size: 17 })
              ],
              spacing: { after: 60 }
            }));
          });
        }
        
        // SKILLS CHECKLIST
        if (additional?.skills?.length) {
          children.push(sectionHeader('Skills Checklist'));
          // Display in columns
          const skillsText = additional.skills.map(s => `✓ ${s}`).join('   |   ');
          children.push(new Paragraph({
            children: [new TextRun({ text: skillsText, size: 17 })],
            spacing: { after: 100 }
          }));
        }
        
        // CERTS (detailed)
        if (additional?.certDetails?.some(c => c.name)) {
          children.push(sectionHeader('Certifications'));
          additional.certDetails.filter(c => c.name).forEach(cert => {
            children.push(new Paragraph({
              children: [
                new TextRun({ text: cert.name, bold: true, size: 18 }),
                new TextRun({ text: ` – Expires: ${cert.expDate || 'N/A'}`, size: 17, color: "666666" }),
                cert.certNumber ? new TextRun({ text: ` (Cert #: ${cert.certNumber})`, size: 16, color: "888888" }) : new TextRun({ text: '' })
              ],
              spacing: { after: 40 }
            }));
          });
        }
        
        // NURSYS
        if (additional?.nursysLink || additional?.licenseDetails?.some(l => l.number)) {
          children.push(sectionHeader('Nursys / License Verification'));
          if (additional?.nursysLink) {
            children.push(new Paragraph({
              children: [new TextRun({ text: `Verification Link: ${additional.nursysLink}`, size: 17, color: "0891B2" })],
              spacing: { after: 60 }
            }));
          }
          additional?.licenseDetails?.filter(l => l.state && l.number).forEach(lic => {
            children.push(new Paragraph({
              children: [
                new TextRun({ text: `${lic.state} ${lic.type || 'RN'}: `, bold: true, size: 18 }),
                new TextRun({ text: `#${lic.number} | Issued: ${lic.issueDate || 'N/A'} | Expires: ${lic.expDate || 'N/A'}`, size: 17 })
              ],
              spacing: { after: 40 }
            }));
          });
        }
      }
      
      const doc = new Document({
        sections: [{
          properties: { page: { margin: { top: 500, right: 500, bottom: 500, left: 500 } } },
          children
        }]
      });
      
      const blob = await Packer.toBlob(doc);
      saveAs(blob, `${candidateName.replace(/\s+/g, '_')}_Profile.docx`);
    }

    function App() {
      const [resumeText, setResumeText] = useState('');
      const [loading, setLoading] = useState(false);
      const [fileLoading, setFileLoading] = useState(false);
      const [error, setError] = useState('');
      const [profile, setProfile] = useState(null);
      const [companyName, setCompanyName] = useState('');
      const [companyLogo, setCompanyLogo] = useState(null);
      const [fileName, setFileName] = useState('');
      const [exporting, setExporting] = useState(false);
      const [activeTab, setActiveTab] = useState('summary');
      
      const fileRef = useRef(null);
      const logoRef = useRef(null);
      const profileRef = useRef(null);
      
      const [additional, setAdditional] = useState({
        companyAddress: '',
        companyPhone: '',
        primaryCharting: '',
        summaryBullets: ['', '', '', '', ''],
        licenseDetails: [
          { state: '', type: 'RN', number: '', issueDate: '', expDate: '', compact: false },
          { state: '', type: 'RN', number: '', issueDate: '', expDate: '', compact: false }
        ],
        certDetails: [
          { name: 'BLS', expDate: '', certNumber: '' },
          { name: 'ACLS', expDate: '', certNumber: '' },
          { name: 'PALS', expDate: '', certNumber: '' },
          { name: 'NIHSS', expDate: '', certNumber: '' },
          { name: '', expDate: '', certNumber: '' },
          { name: '', expDate: '', certNumber: '' }
        ],
        workDetails: [],
        skills: [],
        nursysLink: '',
        references: [
          { name: '', title: '', facility: '', phone: '', email: '', relationship: '' },
          { name: '', title: '', facility: '', phone: '', email: '', relationship: '' },
          { name: '', title: '', facility: '', phone: '', email: '', relationship: '' }
        ]
      });

      const handleFile = async (file) => {
        if (!file) return;
        setFileLoading(true);
        setError('');
        setFileName(file.name);
        try {
          let text = '';
          const name = file.name.toLowerCase();
          if (name.endsWith('.pdf')) text = await extractPDF(file);
          else if (name.endsWith('.docx') || name.endsWith('.doc')) text = await extractDOCX(file);
          else if (name.endsWith('.txt')) text = await file.text();
          else throw new Error('Upload PDF, DOCX, or TXT');
          setResumeText(text);
        } catch (err) {
          setError(err.message);
          setFileName('');
        } finally {
          setFileLoading(false);
        }
      };

      const handleExtract = async () => {
        if (!resumeText.trim()) { setError('Please upload or paste resume'); return; }
        setLoading(true);
        setError('');
        try {
          const res = await fetch('/api/extract', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ resumeText })
          });
          const data = await res.json();
          if (data.error) { setError(data.error); }
          else {
            setProfile(data);
            if (data.workHistory?.length) {
              const workDetails = data.workHistory.map(job => ({
                facility: job.facility || '', city: job.city || '', state: job.state || '',
                startDate: job.startDate || '', endDate: job.endDate || '', title: job.title || '',
                roleDescription: '', totalBeds: '', traumaLevel: '', facilityType: '',
                orSuites: '', robotics: false, roboticsSystem: '', charting: '',
                duties: job.responsibilities?.join('. ') || ''
              }));
              setAdditional(prev => ({ ...prev, workDetails }));
            }
            if (data.licenses?.length) {
              const licenseDetails = data.licenses.map(l => ({
                state: l.state || '', type: l.type || 'RN', number: '', issueDate: '', expDate: '', compact: l.compact || false
              }));
              while (licenseDetails.length < 2) licenseDetails.push({ state: '', type: 'RN', number: '', issueDate: '', expDate: '', compact: false });
              setAdditional(prev => ({ ...prev, licenseDetails }));
            }
            if (data.certifications?.length) {
              const certDetails = data.certifications.map(c => ({ name: c, expDate: '', certNumber: '' }));
              while (certDetails.length < 6) certDetails.push({ name: '', expDate: '', certNumber: '' });
              setAdditional(prev => ({ ...prev, certDetails }));
            }
          }
        } catch (err) { setError('Failed to process resume'); }
        finally { setLoading(false); }
      };

      const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onloadend = () => setCompanyLogo(reader.result);
          reader.readAsDataURL(file);
        }
      };

      const handleExportDOCX = async () => {
        setExporting(true);
        try { await exportDOCX(profile, companyName, additional); }
        catch (err) { console.error(err); alert('Export failed: ' + err.message); }
        finally { setExporting(false); }
      };

      const updateLicense = (idx, field, value) => {
        setAdditional(prev => {
          const newLics = [...prev.licenseDetails];
          newLics[idx] = { ...newLics[idx], [field]: value };
          return { ...prev, licenseDetails: newLics };
        });
      };

      const updateCert = (idx, field, value) => {
        setAdditional(prev => {
          const newCerts = [...prev.certDetails];
          newCerts[idx] = { ...newCerts[idx], [field]: value };
          return { ...prev, certDetails: newCerts };
        });
      };

      const updateWork = (idx, field, value) => {
        setAdditional(prev => {
          const newWork = [...prev.workDetails];
          newWork[idx] = { ...newWork[idx], [field]: value };
          return { ...prev, workDetails: newWork };
        });
      };

      const updateRef = (idx, field, value) => {
        setAdditional(prev => {
          const refs = [...prev.references];
          refs[idx] = { ...refs[idx], [field]: value };
          return { ...prev, references: refs };
        });
      };

      const updateSummary = (idx, value) => {
        setAdditional(prev => {
          const bullets = [...prev.summaryBullets];
          bullets[idx] = value;
          return { ...prev, summaryBullets: bullets };
        });
      };

      const toggleSkill = (skill) => {
        setAdditional(prev => ({
          ...prev,
          skills: prev.skills.includes(skill) ? prev.skills.filter(s => s !== skill) : [...prev.skills, skill]
        }));
      };

      const suggestedSkills = profile?.primarySpecialty ? SKILLS_BY_SPECIALTY[profile.primarySpecialty] || SKILLS_BY_SPECIALTY['Med-Surg'] : [];

      const tabs = [
        { id: 'summary', label: 'Summary' },
        { id: 'licenses', label: 'Licenses' },
        { id: 'certs', label: 'Certs' },
        { id: 'work', label: 'Work' },
        { id: 'skills', label: 'Skills' },
        { id: 'refs', label: 'Refs' }
      ];

      return (
        <div className="min-h-screen bg-gray-100">
          <header className="bg-white border-b sticky top-0 z-50 no-print">
            <div className="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 bg-cyan-600 rounded-lg flex items-center justify-center">
                  <svg className="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <h1 className="text-base font-bold text-gray-800">Profile Builder Pro</h1>
              </div>
              {profile && (
                <button onClick={handleExportDOCX} disabled={exporting} className="px-4 py-1.5 bg-cyan-600 text-white text-sm font-medium rounded-lg hover:bg-cyan-700 disabled:opacity-50">
                  {exporting ? 'Exporting...' : 'Download DOCX'}
                </button>
              )}
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-4">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* LEFT */}
              <div className="space-y-3 no-print">
                {/* Company */}
                <div className="bg-white rounded-lg border p-3">
                  <h2 className="text-xs font-semibold mb-2 text-gray-500 uppercase">Company</h2>
                  <input type="text" value={companyName} onChange={(e) => setCompanyName(e.target.value)} placeholder="Staffing Agency Name" className="w-full px-2 py-1.5 border rounded text-sm mb-2" />
                  <div className="grid grid-cols-2 gap-2">
                    <input type="text" value={additional.companyAddress} onChange={(e) => setAdditional(prev => ({ ...prev, companyAddress: e.target.value }))} placeholder="Address" className="px-2 py-1.5 border rounded text-xs" />
                    <input type="text" value={additional.companyPhone} onChange={(e) => setAdditional(prev => ({ ...prev, companyPhone: e.target.value }))} placeholder="Phone" className="px-2 py-1.5 border rounded text-xs" />
                  </div>
                  <div className="flex items-center gap-2 mt-2">
                    <input type="file" ref={logoRef} onChange={handleLogoUpload} accept="image/*" className="hidden" />
                    <button onClick={() => logoRef.current?.click()} className="px-3 py-1 border rounded text-xs hover:bg-gray-50">
                      {companyLogo ? 'Change Logo' : 'Upload Logo'}
                    </button>
                    {companyLogo && <img src={companyLogo} alt="Logo" className="h-8 object-contain" />}
                  </div>
                </div>

                {/* Upload */}
                <div className="bg-white rounded-lg border p-3">
                  <h2 className="text-xs font-semibold mb-2 text-gray-500 uppercase">Resume</h2>
                  <div onClick={() => fileRef.current?.click()} className="border-2 border-dashed rounded p-3 text-center cursor-pointer hover:border-cyan-400 hover:bg-cyan-50 transition mb-2">
                    <input type="file" ref={fileRef} onChange={(e) => handleFile(e.target.files[0])} accept=".pdf,.docx,.doc,.txt" className="hidden" />
                    {fileLoading ? <span className="text-cyan-600 text-xs">Extracting...</span> : fileName ? (
                      <div><span className="text-green-600 text-xs font-medium">{fileName}</span></div>
                    ) : <span className="text-gray-400 text-xs">Drop PDF, DOCX, or TXT</span>}
                  </div>
                  <textarea value={resumeText} onChange={(e) => { setResumeText(e.target.value); setFileName(''); }} placeholder="Or paste resume..." className="w-full h-16 px-2 py-1.5 border rounded text-xs resize-none" />
                  {error && <div className="mt-1 p-1.5 bg-red-50 border border-red-200 rounded text-red-700 text-xs">{error}</div>}
                  <button onClick={handleExtract} disabled={loading || fileLoading} className="mt-2 w-full py-1.5 bg-cyan-600 text-white text-sm font-medium rounded hover:bg-cyan-700 disabled:opacity-50">
                    {loading ? 'Processing...' : 'Extract & Build'}
                  </button>
                </div>

                {/* Tabs */}
                {profile && (
                  <div className="bg-white rounded-lg border overflow-hidden">
                    <div className="flex border-b bg-gray-50">
                      {tabs.map(tab => (
                        <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-1 py-1.5 text-xs font-medium ${activeTab === tab.id ? 'bg-white border-b-2 border-cyan-600 text-cyan-600' : 'text-gray-500'}`}>
                          {tab.label}
                        </button>
                      ))}
                    </div>
                    
                    <div className="p-3 max-h-80 overflow-y-auto">
                      {activeTab === 'summary' && (
                        <div className="space-y-2">
                          <select value={additional.primaryCharting} onChange={(e) => setAdditional(prev => ({ ...prev, primaryCharting: e.target.value }))} className="w-full px-2 py-1.5 border rounded text-xs">
                            <option value="">Primary Charting System</option>
                            {CHARTING_SYSTEMS.map(c => <option key={c} value={c}>{c}</option>)}
                          </select>
                          <div className="text-xs text-gray-500">Summary Bullets:</div>
                          {additional.summaryBullets.map((b, i) => (
                            <input key={i} type="text" value={b} onChange={(e) => updateSummary(i, e.target.value)} placeholder={`Bullet ${i + 1}`} className="w-full px-2 py-1 border rounded text-xs" />
                          ))}
                          <input type="url" value={additional.nursysLink} onChange={(e) => setAdditional(prev => ({ ...prev, nursysLink: e.target.value }))} placeholder="Nursys Link" className="w-full px-2 py-1.5 border rounded text-xs" />
                        </div>
                      )}

                      {activeTab === 'licenses' && (
                        <div className="space-y-3">
                          {additional.licenseDetails.map((lic, i) => (
                            <div key={i} className="p-2 bg-gray-50 rounded text-xs space-y-1">
                              <div className="grid grid-cols-4 gap-1">
                                <input type="text" value={lic.state} onChange={(e) => updateLicense(i, 'state', e.target.value)} placeholder="State" className="px-1.5 py-1 border rounded" />
                                <select value={lic.type} onChange={(e) => updateLicense(i, 'type', e.target.value)} className="px-1.5 py-1 border rounded">
                                  <option value="RN">RN</option><option value="LPN">LPN</option>
                                </select>
                                <input type="text" value={lic.number} onChange={(e) => updateLicense(i, 'number', e.target.value)} placeholder="License #" className="px-1.5 py-1 border rounded" />
                                <label className="flex items-center gap-1"><input type="checkbox" checked={lic.compact} onChange={(e) => updateLicense(i, 'compact', e.target.checked)} />Compact</label>
                              </div>
                              <div className="grid grid-cols-2 gap-1">
                                <input type="text" value={lic.issueDate} onChange={(e) => updateLicense(i, 'issueDate', e.target.value)} placeholder="Issue Date" className="px-1.5 py-1 border rounded" />
                                <input type="text" value={lic.expDate} onChange={(e) => updateLicense(i, 'expDate', e.target.value)} placeholder="Exp Date" className="px-1.5 py-1 border rounded" />
                              </div>
                            </div>
                          ))}
                          <button onClick={() => setAdditional(prev => ({ ...prev, licenseDetails: [...prev.licenseDetails, { state: '', type: 'RN', number: '', issueDate: '', expDate: '', compact: false }] }))} className="text-xs text-cyan-600">+ Add</button>
                        </div>
                      )}

                      {activeTab === 'certs' && (
                        <div className="space-y-1">
                          {additional.certDetails.map((c, i) => (
                            <div key={i} className="grid grid-cols-3 gap-1">
                              <input type="text" value={c.name} onChange={(e) => updateCert(i, 'name', e.target.value)} placeholder="Name" className="px-1.5 py-1 border rounded text-xs" />
                              <input type="text" value={c.expDate} onChange={(e) => updateCert(i, 'expDate', e.target.value)} placeholder="Exp Date" className="px-1.5 py-1 border rounded text-xs" />
                              <input type="text" value={c.certNumber} onChange={(e) => updateCert(i, 'certNumber', e.target.value)} placeholder="Cert #" className="px-1.5 py-1 border rounded text-xs" />
                            </div>
                          ))}
                          <button onClick={() => setAdditional(prev => ({ ...prev, certDetails: [...prev.certDetails, { name: '', expDate: '', certNumber: '' }] }))} className="text-xs text-cyan-600">+ Add</button>
                        </div>
                      )}

                      {activeTab === 'work' && (
                        <div className="space-y-3">
                          {additional.workDetails.map((job, i) => (
                            <div key={i} className="p-2 bg-gray-50 rounded text-xs">
                              <div className="font-medium mb-1">{job.facility || `Job ${i + 1}`}</div>
                              <div className="grid grid-cols-2 gap-1 mb-1">
                                <input type="text" value={job.totalBeds} onChange={(e) => updateWork(i, 'totalBeds', e.target.value)} placeholder="Beds" className="px-1.5 py-1 border rounded" />
                                <select value={job.traumaLevel} onChange={(e) => updateWork(i, 'traumaLevel', e.target.value)} className="px-1.5 py-1 border rounded">
                                  <option value="">Trauma</option>
                                  {TRAUMA_LEVELS.map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                              </div>
                              <div className="grid grid-cols-2 gap-1 mb-1">
                                <select value={job.charting} onChange={(e) => updateWork(i, 'charting', e.target.value)} className="px-1.5 py-1 border rounded">
                                  <option value="">Charting</option>
                                  {CHARTING_SYSTEMS.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <input type="text" value={job.orSuites} onChange={(e) => updateWork(i, 'orSuites', e.target.value)} placeholder="OR Suites" className="px-1.5 py-1 border rounded" />
                              </div>
                              <div className="flex items-center gap-2 mb-1">
                                <label className="flex items-center gap-1"><input type="checkbox" checked={job.robotics} onChange={(e) => updateWork(i, 'robotics', e.target.checked)} />Robotics</label>
                                {job.robotics && <input type="text" value={job.roboticsSystem} onChange={(e) => updateWork(i, 'roboticsSystem', e.target.value)} placeholder="System" className="px-1.5 py-1 border rounded flex-1" />}
                              </div>
                              <input type="text" value={job.roleDescription} onChange={(e) => updateWork(i, 'roleDescription', e.target.value)} placeholder="Role Description" className="w-full px-1.5 py-1 border rounded mb-1" />
                              <textarea value={job.duties} onChange={(e) => updateWork(i, 'duties', e.target.value)} placeholder="Duties" className="w-full px-1.5 py-1 border rounded h-12 resize-none" />
                            </div>
                          ))}
                        </div>
                      )}

                      {activeTab === 'skills' && (
                        <div>
                          <div className="flex flex-wrap gap-1">
                            {suggestedSkills.map(skill => (
                              <button key={skill} onClick={() => toggleSkill(skill)} className={`px-2 py-0.5 rounded text-xs ${additional.skills.includes(skill) ? 'bg-cyan-600 text-white' : 'bg-gray-100 text-gray-700'}`}>
                                {additional.skills.includes(skill) ? '✓ ' : ''}{skill}
                              </button>
                            ))}
                          </div>
                          <div className="mt-2 text-xs text-gray-500">{additional.skills.length} selected</div>
                        </div>
                      )}

                      {activeTab === 'refs' && (
                        <div className="space-y-2">
                          {additional.references.map((ref, i) => (
                            <div key={i} className="p-2 bg-gray-50 rounded text-xs grid grid-cols-2 gap-1">
                              <input type="text" value={ref.name} onChange={(e) => updateRef(i, 'name', e.target.value)} placeholder="Name" className="px-1.5 py-1 border rounded" />
                              <input type="text" value={ref.title} onChange={(e) => updateRef(i, 'title', e.target.value)} placeholder="Title" className="px-1.5 py-1 border rounded" />
                              <input type="text" value={ref.facility} onChange={(e) => updateRef(i, 'facility', e.target.value)} placeholder="Facility" className="px-1.5 py-1 border rounded" />
                              <input type="text" value={ref.relationship} onChange={(e) => updateRef(i, 'relationship', e.target.value)} placeholder="Relationship" className="px-1.5 py-1 border rounded" />
                              <input type="text" value={ref.phone} onChange={(e) => updateRef(i, 'phone', e.target.value)} placeholder="Phone" className="px-1.5 py-1 border rounded" />
                              <input type="text" value={ref.email} onChange={(e) => updateRef(i, 'email', e.target.value)} placeholder="Email" className="px-1.5 py-1 border rounded" />
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* RIGHT - Preview */}
              <div>
                {profile ? (
                  <div ref={profileRef}>
                    <ProfilePreview data={profile} companyName={companyName} companyLogo={companyLogo} additional={additional} />
                  </div>
                ) : (
                  <div className="bg-white rounded-lg border p-8 text-center text-gray-400 text-sm">
                    Upload a resume to generate profile
                  </div>
                )}
              </div>
            </div>
          </main>
        </div>
      );
    }

    function ProfilePreview({ data, companyName, companyLogo, additional }) {
      const { personalInfo, education, yearsExperience, primarySpecialty } = data;
      const activeLicenses = additional?.licenseDetails?.filter(l => l.state) || [];
      const activeCerts = additional?.certDetails?.filter(c => c.name) || [];

      return (
        <div className="bg-white rounded-lg border overflow-hidden text-sm diagonal-bg">
          {/* Header */}
          <div className="p-4 border-b bg-white">
            <div className="flex justify-between items-start">
              <div className="flex items-center gap-2">
                {companyLogo && <img src={companyLogo} alt="" className="h-10 object-contain" />}
                <span className="font-bold text-cyan-600 text-lg">{companyName || 'STAFFING AGENCY'}</span>
              </div>
              <div className="text-right">
                <div className="font-bold">{personalInfo?.fullName || 'Candidate'}</div>
                <div className="text-xs text-gray-600">{personalInfo?.phone}</div>
                <div className="text-xs text-gray-600">{personalInfo?.email}</div>
                <div className="text-xs text-gray-600">{personalInfo?.location}</div>
              </div>
            </div>
          </div>

          {/* Summary */}
          {additional?.summaryBullets?.some(b => b) && (
            <div className="px-4 py-2 bg-cyan-50 border-b text-xs">
              {additional.summaryBullets.filter(b => b).map((b, i) => <div key={i}>• {b}</div>)}
            </div>
          )}

          {/* Two columns */}
          <div className="flex">
            {/* Left */}
            <div className="w-1/3 border-r p-3 space-y-3">
              <div>
                <div className="section-header text-white text-xs font-bold px-2 py-1 rounded-t">Experience</div>
                <div className="border border-t-0 rounded-b p-2 text-xs space-y-0.5 bg-white">
                  <div><b>Specialties:</b> {primarySpecialty || 'RN'}</div>
                  <div><b>Years:</b> {yearsExperience || '—'}+</div>
                  <div><b>Charting:</b> {additional?.primaryCharting || 'Various'}</div>
                </div>
              </div>
              <div>
                <div className="section-header text-white text-xs font-bold px-2 py-1 rounded-t">Licenses & Certs</div>
                <div className="border border-t-0 rounded-b p-2 text-xs space-y-1 bg-white">
                  {activeLicenses.map((l, i) => (
                    <div key={i}>
                      <div className="font-medium">{l.type}, {l.state} – Exp. {l.expDate || 'N/A'}</div>
                      {l.number && <div className="text-gray-500 text-xs">{l.number}</div>}
                    </div>
                  ))}
                  {activeCerts.map((c, i) => <div key={i} className="text-gray-700">{c.name} (Exp: {c.expDate || 'N/A'})</div>)}
                </div>
              </div>
              <div>
                <div className="section-header text-white text-xs font-bold px-2 py-1 rounded-t">Education</div>
                <div className="border border-t-0 rounded-b p-2 text-xs bg-white">
                  {education ? (
                    <>
                      <div><b>Grad:</b> {education.graduationDate || 'N/A'}</div>
                      <div>{education.school}</div>
                      <div>{education.degree}</div>
                    </>
                  ) : <div className="text-gray-400">N/A</div>}
                </div>
              </div>
            </div>

            {/* Right - Work History */}
            <div className="w-2/3 p-3">
              <div className="section-header text-white text-xs font-bold px-2 py-1 rounded mb-2">Work History</div>
              <div className="space-y-3">
                {additional?.workDetails?.length > 0 ? additional.workDetails.map((job, i) => (
                  <div key={i} className="border-b pb-2 last:border-b-0 text-xs">
                    <div className="flex justify-between">
                      <span className="font-bold">{job.facility} – {job.city}, {job.state}</span>
                      <span className="text-gray-500 text-xs">{job.startDate} – {job.endDate}</span>
                    </div>
                    <div className="text-gray-700">{job.title}</div>
                    {job.roleDescription && <div className="text-gray-600">{job.roleDescription}</div>}
                    <div className="mt-1 text-xs text-gray-600 space-y-0.5">
                      {job.totalBeds && <div>Total Staffed Beds: {job.totalBeds}</div>}
                      {(job.traumaLevel || job.facilityType) && <div>Facility Type: {[job.traumaLevel, job.facilityType].filter(Boolean).join(' and ')}</div>}
                      {job.orSuites && <div>Number of OR suites: {job.orSuites}</div>}
                      {job.robotics && <div>Robotics: Yes ({job.roboticsSystem || 'Da Vinci'})</div>}
                      {job.charting && <div>Charting System: {job.charting}</div>}
                    </div>
                    {job.duties && <div className="mt-1"><b>Duties:</b> {job.duties}</div>}
                  </div>
                )) : <div className="text-gray-400">Add details in Work tab</div>}
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="px-4 py-2 bg-gray-50 border-t text-center text-xs text-gray-400">
            {[additional?.companyAddress, additional?.companyPhone].filter(Boolean).join(' | ')}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
